name: Taboor CI

on:
  push:
    branches: [ main ]

jobs:
  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate critical files
      run: |
        echo "=== PROJECT STRUCTURE VALIDATION ==="
        
        # Critical files that must exist
        critical_files=(
          "frontend/index.html"
          "frontend/main.js" 
          "frontend/styles.css"
          "backend/Nootbook.ipynb"
          "backend/queue_data.csv"
          "backend/server.js"
          "database/taboor.db"
          "database/schema.sql"
        )
        
        all_files_exist=true
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ MISSING: $file"
            all_files_exist=false
          fi
        done
        
        if [ "$all_files_exist" = false ]; then
          echo "🚨 Critical files missing - failing CI"
          exit 1
        fi
        
        echo "✅ All critical files present"

  validate-syntax:
    name: Validate Code Syntax
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Validate Python syntax
      run: |
        echo "=== PYTHON SYNTAX VALIDATION ==="
        
        # Find all Python files
        python_files=$(find . -name "*.py" -type f)
        
        if [ -z "$python_files" ]; then
          echo "ℹ️ No Python files found"
          exit 0
        fi
        
        echo "Checking Python files:"
        echo "$python_files"
        
        # Check each Python file - shows exact errors but continues
        error_found=false
        for file in $python_files; do
          echo "Checking: $file"
          # Use py_compile but capture output without stopping
          output=$(python -m py_compile "$file" 2>&1)
          if [ $? -eq 0 ]; then
            echo "✅ $file - Syntax OK"
          else
            echo "❌ SYNTAX ERROR in: $file"
            echo "   Error details: $output"  # Shows exact error with line numbers
            error_found=true
          fi
        done
        
        # Only exit after checking ALL files
        if [ "$error_found" = true ]; then
          echo "🚨 Python syntax errors found"
          echo "PYTHON_ERRORS=true" >> $GITHUB_ENV
        else
          echo "✅ All Python files have valid syntax"
        fi
      continue-on-error: true

    - name: Validate JavaScript syntax
      run: |
        echo "=== JAVASCRIPT SYNTAX VALIDATION ==="
        
        # Find all JavaScript files
        js_files=$(find . -name "*.js" -type f)
        
        if [ -z "$js_files" ]; then
          echo "ℹ️ No JavaScript files found"
          exit 0
        fi
        
        echo "Checking JavaScript files:"
        echo "$js_files"
        
        # Check each JavaScript file but CONTINUE to find ALL errors
        error_found=false
        for file in $js_files; do
          echo "Checking: $file"
          # Capture JavaScript syntax errors without stopping
          output=$(node -c "$file" 2>&1)
          if [ $? -eq 0 ]; then
            echo "✅ $file - Syntax OK"
          else
            echo "❌ SYNTAX ERROR in: $file"
            echo "   Error details: $output"  # Shows exact JavaScript error
            error_found=true
          fi
        done
        
        # Only exit after checking ALL files
        if [ "$error_found" = true ]; then
          echo "🚨 JavaScript syntax errors found"
          echo "JAVASCRIPT_ERRORS=true" >> $GITHUB_ENV
        else
          echo "✅ All JavaScript files have valid syntax"
        fi
      continue-on-error: true

    - name: Fail if any syntax errors found
      run: |
        echo "=== FINAL SYNTAX VALIDATION RESULT ==="
        if [ "$PYTHON_ERRORS" = "true" ] || [ "$JAVASCRIPT_ERRORS" = "true" ]; then
          echo "🚨 CI FAILED: Syntax errors detected in the code"
          echo "Please fix all syntax errors shown above"
          exit 1
        else
          echo "✅ All syntax checks passed!"
        fi