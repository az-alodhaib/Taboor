name: Taboor

on:
  push:
    branches: [ main ]

jobs: 
  ci-pipeline:
    name: CI pipeline
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v4  

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Check Python syntax
      run: |
        echo "=== Python Syntax Validation ==="
        echo "ğŸ” Checking Python files for syntax errors..."
        
        # Check if any Python files exist
        if find . -name "*.py" | grep -q "."; then
          echo "Found Python files. Checking syntax..."
          # Check each Python file for syntax errors
          find . -name "*.py" -exec python -m py_compile {} \; && echo "âœ… All Python files have valid syntax!"
        else
          echo "No Python files found to check"
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check JavaScript syntax
      run: |
        echo "=== JavaScript Syntax Validation ==="
        echo "ğŸ” Checking JavaScript files for syntax errors..."
        
        # Check frontend Main.js
        if [ -f "frontend/Main.js" ]; then
          echo "ğŸ“ Checking frontend/Main.js..."
          node -c frontend/Main.js && echo "âœ… frontend/Main.js syntax valid!"
        else
          echo "â„¹ï¸  frontend/Main.js not found"
        fi
        
        # Check backend server.js
        if [ -f "backend/server.js" ]; then
          echo "ğŸ“ Checking backend/server.js..."
          node -c backend/server.js && echo "âœ… backend/server.js syntax valid!"
        else
          echo "â„¹ï¸  backend/server.js not found"
        fi

    - name: Validate project structure
      run: |
        echo "=== Project Structure Validation ==="
        echo "ğŸ—ï¸  Checking if all critical project files exist..."
        
        # Frontend files
        echo "--- Frontend Structure ---"
        [ -f "frontend/index.html" ] && echo "âœ… frontend/index.html exists" || echo "âŒ frontend/index.html missing"
        [ -f "frontend/Main.js" ] && echo "âœ… frontend/Main.js exists" || echo "âŒ frontend/Main.js missing"
        [ -f "frontend/style.css" ] && echo "âœ… frontend/style.css exists" || echo "âŒ frontend/style.css missing"
        
        # Backend files
        echo "--- Backend Structure ---"
        [ -f "backend/Nootbook.ipynb" ] && echo "âœ… backend/Nootbook.ipynb exists" || echo "âŒ backend/Nootbook.ipynb missing"
        [ -f "backend/queue_data.csv" ] && echo "âœ… backend/queue_data.csv exists" || echo "âŒ backend/queue_data.csv missing"
        [ -f "backend/server.js" ] && echo "âœ… backend/server.js exists" || echo "âŒ backend/server.js missing"
        
        # Database files
        echo "--- Database Structure ---"
        [ -f "database/taboor.db" ] && echo "âœ… database/taboor.db exists" || echo "âŒ database/taboor.db missing"
        [ -f "database/schema.sql" ] && echo "âœ… database/schema.sql exists" || echo "âŒ database/schema.sql missing"
        
        echo "ğŸ“‹ Project structure validation completed!"

    - name: Execute Python tests
      run: |
        echo "=== Python Test Execution ==="
        echo "ğŸ§ª Running Python unit tests..."
        
        # Install pytest if not already installed
        pip install pytest
        
        # Check if any test files exist and run them
        if find . -name "test_*.py" | grep -q "."; then
          echo "ğŸ“ Found Python test files. Running tests..."
          python -m pytest -v
        else
          echo "â„¹ï¸  No Python test files found to execute"
        fi

    - name: Execute JavaScript tests
      run: |
        echo "=== JavaScript Test Execution ==="
        echo "ğŸ§ª Running JavaScript unit tests..."
        
        # Check if any test files exist and run them
        if find . -name "test_*.js" | grep -q "."; then
          echo "ğŸ“ Found JavaScript test files. Running tests..."
          # Run each JavaScript test file
          find . -name "test_*.js" -exec node {} \;
        else
          echo "â„¹ï¸  No JavaScript test files found to execute"
        fi

    - name: Generate CI Report
      run: |
        echo " "
        echo "=========================================="
        echo "ğŸš€ TABOOR CI PIPELINE - FINAL REPORT"
        echo "=========================================="
        echo " "
        echo "ğŸ“Š VALIDATION SUMMARY:"
        echo "â”œâ”€â”€ âœ… Python Syntax: Validated"
        echo "â”œâ”€â”€ âœ… JavaScript Syntax: Validated" 
        echo "â”œâ”€â”€ âœ… Project Structure: Verified"
        echo "â”œâ”€â”€ âœ… Python Tests: Executed"
        echo "â””â”€â”€ âœ… JavaScript Tests: Executed"
        echo " "
        echo "ğŸ‰ SUCCESS: All CI checks passed!"
        echo "ğŸ’¡ Your code is ready for deployment."
        echo " "
        echo "=========================================="